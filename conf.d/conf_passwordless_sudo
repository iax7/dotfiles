#!/usr/bin/env bash
# =============================================================================
# conf_passwordless_sudo: Configure passwordless sudo for current user
# =============================================================================
# Description: Creates sudoers.d entry to allow passwordless sudo with
#              environment variable preservation (http_proxy, etc.)
# WARNING: This grants elevated privileges. Use with caution.
# =============================================================================
set -euo pipefail

# Source .common from DOTFILES_DIR or find it relative to this script
if [[ -n "${DOTFILES_DIR:-}" ]]; then
  source "$DOTFILES_DIR/bin/.common" || exit 1
else
  source "$(dirname "$(dirname "$0")")/bin/.common" || exit 1
fi

msg "User: $GRE$USER$RST"
SUDOERS_FILE="/etc/sudoers.d/$TARGET_USER"

# Validate if already exists
if sudo test -f "$SUDOERS_FILE" 2>/dev/null; then
  msg_ok "Sudoers file already exists for user"
  msg "Current content:"
  sudo cat -n "$SUDOERS_FILE"
  exit 0
fi

sudo tee "$SUDOERS_FILE" > /dev/null << EOF
$USER ALL=(ALL) NOPASSWD:ALL
EOF
sudo chmod 0440 "$SUDOERS_FILE"
